<!DOCTYPE html>
<html xmlns:t="http://twistedmatrix.com/ns/twisted.web.template/0.1" t:render="root">

  <head>
    <div t:render="head_common" />
    <link type="text/css" rel="stylesheet" media="screen"><t:attr name="href"><t:slot name="datatables_css_url" /></t:attr></link>
    <script><t:attr name="src"><t:slot name="datatables_js_url" /></t:attr></script>
  </head>

  <body><div t:render="container">

    <table class="table table-striped table-hover" id="queue_table">
      <thead>
        <tr>
          <th t:render="table_headers" />
        </tr>
      </thead>
      <tbody />
      <tfoot>
        <tr>
          <th t:render="table_headers" />
        </tr>
      </tfoot>
    </table>

    <script>
      var resultColumns = [
        <javascript t:render="results" />
      ];

      //<![CDATA[

      function orUnknown(stringValue) {
        if (stringValue == undefined) {
          return "?";
        } else {
          return stringValue;
        };
      };

      function dataHandler(incidents) {
        for (var i in incidents) {
          incident = incidents[i];

          switch (incident.priority) {
            case 1:
              incident.priority = "High";
              break;
            case 2:
              incident.priority = "High";
              break;
            case 3:
              incident.priority = "Medium";
              break;
            case 4:
              incident.priority = "Low";
              break;
            case 5:
              incident.priority = "Low";
              break;
          };

          // FIXME: August getMonth() is returning 7?
          console.log("TIME:")
          console.log(incident.timestamp);
          var created = new Date(incident.timestamp);
          console.log(created);
          incident.timestamp = (
            created.getMonth()   + "/" +
            created.getDate()    + "@" +
            created.getHours()   + ":" +
            created.getMinutes()
          );
          console.log(incident.timestamp);
          console.log("------");

          switch (incident.state) {
            case "new":
              incident.state = "New";
              break;
            case "on_hold":
              incident.state = "On Hold";
              break;
            case "dispatched":
              incident.state = "Dispatched";
              break;
            case "on_scene":
              incident.state = "On Scene";
              break;
            case "closed":
              incident.state = "Closed";
              break;
          };

          if (incident.ranger_handles == undefined) {
            incident.ranger_handles = "";
          } else {
            incident.ranger_handles = incident.ranger_handles.sort().join(", ");
          };

          if (incident.location == undefined) {
            incident.location = "";
          } else {
            var location = [];

            if (incident.location.name != undefined) {
              location.push(incident.location.name);
            };

            switch (incident.location.type) {
              case "text":
                break;
              case "garett":
                var address = "(";
                address += orUnknown(incident.location.radial_hour);

                address += "XXXXX";

                address += ")";
                break;
              default:
                location.push(
                  "Unknown location type:" + incident.location.type
                );
                break;
            };

            incident.location = location.join(" ");
          };

          incident.incident_types = "INCIDENT TYPES";
          incident.summary = "SUMMARY";

        };

        return incidents;
      };

      $("#queue_table").DataTable({
          "deferRender": true,
          "paging": true,
          "lengthChange": true,
          "lengthMenu": [ [25, 50, 100, -1], ["25", "50", "100", "All"] ],
          "processing": true,
          "scrollX": false, "scrollY": false,
          "ajax": {
              "url": "data",
              "dataSrc": dataHandler,
          },
          "columns": resultColumns,
      });

      $("#result_info").css({"display": "none"});

      //]]>
    </script>

  </div></body>

</html>
